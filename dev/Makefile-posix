# --------------------------------------------------------------------------
# Builds:
#   diskimage
#	libtool
#	keymap
#   makerom
#   libclap
#
# and puts them inside the build/host folder.
#


# --------------------------------------------------------------------------
# Common Directories
#

BUILD_DIR := ../build
TOOLS_DIR := $(BUILD_DIR)/host
OBJS_DIR := $(TOOLS_DIR)/objs
LIBS_DIR := ../user/lib
TOOLS_SOURCES_DIR := bin
LIBCLAP_DIR := $(LIBS_DIR)/libclap
LIBCLAP_HEADERS_DIR := $(LIBCLAP_DIR)/h
LIBCLAP_SOURCES_DIR := $(LIBCLAP_DIR)/src


# --------------------------------------------------------------------------
# Common Settings
#

#DEBUG_FLAGS := /Od /Zi
DEBUG_FLAGS :=


# --------------------------------------------------------------------------
# Includes
#

include ../common.mk


# --------------------------------------------------------------------------
# Build rules
#

.SUFFIXES:
.PHONY: clean


default: all

all: libclap makerom libtool keymap
#all: libclap makerom libtool keymap diskimage
diskimage: $(TOOLS_DIR)/diskimage
keymap: $(TOOLS_DIR)/keymap
libtool: $(TOOLS_DIR)/libtool
makerom: $(TOOLS_DIR)/makerom
libclap: $(OBJS_DIR)/libclap.ar

clean:
	$(call rm_if_exists,$(OBJS_DIR))


$(TOOLS_DIR):
	$(call mkdir_if_needed,$(TOOLS_DIR))

$(OBJS_DIR):
	$(call mkdir_if_needed,$(OBJS_DIR))


# --------------------------------------------------------------------------
# libclap
#

LIBCLAP_H_SOURCES := $(wildcard $(LIBCLAP_SOURCES_DIR)/*.h)
LIBCLAP_C_SOURCES := $(wildcard $(LIBCLAP_SOURCES_DIR)/*.c)
LIBCLAP_OBJS := $(patsubst $(LIBCLAP_SOURCES_DIR)/%.c, $(OBJS_DIR)/%.o, $(LIBCLAP_C_SOURCES))

$(OBJS_DIR)/libclap.ar: $(LIBCLAP_OBJS)
	ar rvs $@ $^

$(OBJS_DIR)%.o: $(LIBCLAP_SOURCES_DIR)%.c $(LIBCLAP_H_SOURCES) | $(OBJS_DIR)
	gcc -c -I$(LIBCLAP_HEADERS_DIR) $(DEBUG_FLAGS) -Wno-nullability-completeness -o $@ $<


# --------------------------------------------------------------------------
# diskimage
#

EXT_SOURCES_DIR := ../user/lib/libc/src/ext
EXT_C_SOURCES += $(EXT_SOURCES_DIR)/deque.c
EXT_C_SOURCES += $(EXT_SOURCES_DIR)/hash.c
EXT_C_SOURCES += $(EXT_SOURCES_DIR)/log2_ul.c
EXT_C_SOURCES += $(EXT_SOURCES_DIR)/log2_ull.c
EXT_C_SOURCES += $(EXT_SOURCES_DIR)/pow2_ul.c
EXT_C_SOURCES += $(EXT_SOURCES_DIR)/pow2_ull.c
EXT_C_SOURCES += $(EXT_SOURCES_DIR)/queue.c
EXT_C_SOURCES += $(EXT_SOURCES_DIR)/_Try_bang_failed.c
EXT_OBJS_DIR := $(OBJS_DIR)/ext
EXT_OBJS := $(patsubst $(EXT_SOURCES_DIR)/%.c, $(EXT_OBJS_DIR)/%.o, $(EXT_C_SOURCES))

KERN_SOURCES_DIR := ../kern/src

FM_SOURCES_DIR := $(KERN_SOURCES_DIR)/filemanager
FM_C_SOURCES += $(FM_SOURCES_DIR)/FileHierarchy.c
FM_C_SOURCES += $(FM_SOURCES_DIR)/FileManager_Directory.c
FM_C_SOURCES += $(FM_SOURCES_DIR)/FileManager_File.c
FM_C_SOURCES += $(FM_SOURCES_DIR)/FileManager.c
FM_C_SOURCES += $(FM_SOURCES_DIR)/ResolvedPath.c
FM_OBJS_DIR := $(OBJS_DIR)/filemanager
FM_OBJS := $(patsubst $(FM_SOURCES_DIR)/%.c, $(FM_OBJS_DIR)/%.o, $(FM_C_SOURCES))

FS_SOURCES_DIR := $(KERN_SOURCES_DIR)/filesystem
FS_C_SOURCES += $(FS_SOURCES_DIR)/FSContainer.c
FS_C_SOURCES += $(FS_SOURCES_DIR)/ContainerFilesystem.c
FS_C_SOURCES += $(FS_SOURCES_DIR)/Filesystem.c
FS_C_SOURCES += $(FS_SOURCES_DIR)/FSChannel.c
FS_C_SOURCES += $(FS_SOURCES_DIR)/IOChannel.c
FS_C_SOURCES += $(FS_SOURCES_DIR)/Inode.c
FS_C_SOURCES += $(FS_SOURCES_DIR)/InodeChannel.c
FS_C_SOURCES += $(FS_SOURCES_DIR)/PathComponent.c
FS_OBJS_DIR := $(OBJS_DIR)/filesystem
FS_OBJS := $(patsubst $(FS_SOURCES_DIR)/%.c, $(FS_OBJS_DIR)/%.o, $(FS_C_SOURCES))

SEC_SOURCES_DIR := $(KERN_SOURCES_DIR)/security
SEC_C_SOURCES += $(SEC_SOURCES_DIR)/SecurityManager.c
SEC_OBJS_DIR := $(OBJS_DIR)/security
SEC_OBJS := $(patsubst $(SEC_SOURCES_DIR)/%.c, $(SEC_OBJS_DIR)/%.o, $(SEC_C_SOURCES))

KOBJ_SOURCES_DIR := $(KERN_SOURCES_DIR)/kobj
KOBJ_C_SOURCES := $(wildcard $(KOBJ_SOURCES_DIR)/*.c)
KOBJ_OBJS_DIR := $(OBJS_DIR)/kobj
KOBJ_OBJS := $(patsubst $(KOBJ_SOURCES_DIR)/%.c, $(KOBJ_OBJS_DIR)/%.o, $(KOBJ_C_SOURCES))

SEFS_SOURCES_DIR := $(KERN_SOURCES_DIR)/filesystem/serenafs
SEFS_C_SOURCES := $(wildcard $(SEFS_SOURCES_DIR)/*.c)
SEFS_OBJS_DIR := $(OBJS_DIR)/sefs
SEFS_OBJS := $(patsubst $(SEFS_SOURCES_DIR)/%.c, $(SEFS_OBJS_DIR)/%.o, $(SEFS_C_SOURCES))

DISKIMAGE_SOURCES_DIR := diskimage
DISKIMAGE_C_SOURCES := $(wildcard $(DISKIMAGE_SOURCES_DIR)/*.c)
DISKIMAGE_OBJS_DIR := $(OBJS_DIR)/diskimage
DISKIMAGE_OBJS := $(patsubst $(DISKIMAGE_SOURCES_DIR)/%.c, $(DISKIMAGE_OBJS_DIR)/%.o, $(DISKIMAGE_C_SOURCES))

DISKIMAGE_INCLUDES := -I$(DISKIMAGE_SOURCES_DIR) -I$(LIBCLAP_HEADERS_DIR) -I$(KERN_SOURCES_DIR)
DISKIMAGE_CC_FLAGS := -D___STDC_HOSTED__=1 -D__KERNEL__=1 -D__DISKIMAGE__=1 -D__TRY_BANG_LOD=2 -D_ANSI_SOURCE=1 -std=c99 -Wno-nullability-completeness

$(EXT_OBJS_DIR):
	$(call mkdir_if_needed,$(EXT_OBJS_DIR))

$(FM_OBJS_DIR):
	$(call mkdir_if_needed,$(FM_OBJS_DIR))

$(FS_OBJS_DIR):
	$(call mkdir_if_needed,$(FS_OBJS_DIR))

$(SEC_OBJS_DIR):
	$(call mkdir_if_needed,$(SEC_OBJS_DIR))

$(KOBJ_OBJS_DIR):
	$(call mkdir_if_needed,$(KOBJ_OBJS_DIR))

$(SEFS_OBJS_DIR):
	$(call mkdir_if_needed,$(SEFS_OBJS_DIR))

$(DISKIMAGE_OBJS_DIR):
	$(call mkdir_if_needed,$(DISKIMAGE_OBJS_DIR))


$(TOOLS_DIR)/diskimage: $(EXT_OBJS) $(FM_OBJS) $(FS_OBJS) $(SEC_OBJS) $(KOBJ_OBJS) $(SEFS_OBJS) $(DISKIMAGE_OBJS) $(OBJS_DIR)/libclap.ar
	gcc -o $@ $^

$(EXT_OBJS): | $(EXT_OBJS_DIR) $(TOOLS_DIR)

$(FM_OBJS): | $(FM_OBJS_DIR) $(TOOLS_DIR)

$(FS_OBJS): | $(FS_OBJS_DIR) $(TOOLS_DIR)

$(SEC_OBJS): | $(SEC_OBJS_DIR) $(TOOLS_DIR)

$(KOBJ_OBJS): | $(KOBJ_OBJS_DIR) $(TOOLS_DIR)

$(SEFS_OBJS): | $(SEFS_OBJS_DIR) $(TOOLS_DIR)

$(DISKIMAGE_OBJS): | $(DISKIMAGE_OBJS_DIR) $(TOOLS_DIR)

$(EXT_OBJS_DIR)/%.o: $(EXT_SOURCES_DIR)/%.c
	gcc -c $(DISKIMAGE_INCLUDES) $(DISKIMAGE_CC_FLAGS) $(DEBUG_FLAGS) -o $@ $<

$(FM_OBJS_DIR)/%.o: $(FM_SOURCES_DIR)/%.c
	gcc -c $(DISKIMAGE_INCLUDES) $(DISKIMAGE_CC_FLAGS) $(DEBUG_FLAGS) -o $@ $<

$(FS_OBJS_DIR)/%.o: $(FS_SOURCES_DIR)/%.c
	gcc -c $(DISKIMAGE_INCLUDES) $(DISKIMAGE_CC_FLAGS) $(DEBUG_FLAGS) -o $@ $<

$(SEC_OBJS_DIR)/%.o: $(SEC_SOURCES_DIR)/%.c
	gcc -c $(DISKIMAGE_INCLUDES) $(DISKIMAGE_CC_FLAGS) $(DEBUG_FLAGS) -o $@ $<

$(KOBJ_OBJS_DIR)/%.o: $(KOBJ_SOURCES_DIR)/%.c
	gcc -c $(DISKIMAGE_INCLUDES) $(DISKIMAGE_CC_FLAGS) $(DEBUG_FLAGS) -o $@ $<

$(SEFS_OBJS_DIR)/%.o: $(SEFS_SOURCES_DIR)/%.c
	gcc -c $(DISKIMAGE_INCLUDES) $(DISKIMAGE_CC_FLAGS) $(DEBUG_FLAGS) -o $@ $<

$(DISKIMAGE_OBJS_DIR)/%.o: $(DISKIMAGE_SOURCES_DIR)/%.c
	gcc -c $(DISKIMAGE_INCLUDES) $(DISKIMAGE_CC_FLAGS) $(DEBUG_FLAGS) -o $@ $<


# --------------------------------------------------------------------------
# keymap
#

KEYMAP_C_SOURCES := bin/keymap.c
KEYMAP_OBJS := $(patsubst $(TOOLS_SOURCES_DIR)/%.c, $(OBJS_DIR)/%.o, $(KEYMAP_C_SOURCES))

$(TOOLS_DIR)/keymap: $(KEYMAP_OBJS) $(OBJS_DIR)/libclap.ar
	gcc -o $@ $^

$(OBJS_DIR)/%.o: $(TOOLS_SOURCES_DIR)/%.c | $(OBJS_DIR) $(TOOLS_DIR)
	gcc -c -I$(LIBCLAP_HEADERS_DIR) $(DEBUG_FLAGS) -Wno-nullability-completeness -o $@ $<


# --------------------------------------------------------------------------
# libtool
#

LIBTOOL_C_SOURCES := bin/libtool.c
LIBTOOL_OBJS := $(patsubst $(TOOLS_SOURCES_DIR)/%.c, $(OBJS_DIR)/%.o, $(LIBTOOL_C_SOURCES))

$(TOOLS_DIR)/libtool: $(LIBTOOL_OBJS) $(OBJS_DIR)/libclap.ar
	gcc -o $@ $^

$(OBJS_DIR)/%.o: $(TOOLS_SOURCES_DIR)/%.c | $(OBJS_DIR) $(TOOLS_DIR)
	gcc -c -I$(LIBCLAP_HEADERS_DIR) $(DEBUG_FLAGS) -Wno-nullability-completeness -o $@ $<


# --------------------------------------------------------------------------
# makerom
#

MAKEROM_C_SOURCES := bin/makerom.c
MAKEROM_OBJS := $(patsubst $(TOOLS_SOURCES_DIR)/%.c, $(OBJS_DIR)/%.o, $(MAKEROM_C_SOURCES))

$(TOOLS_DIR)/makerom: $(MAKEROM_OBJS) $(OBJS_DIR)/libclap.ar
	gcc -o $@ $^

$(OBJS_DIR)/%.o: $(MAKEROM_C_SOURCES)/.%c | $(OBJS_DIR) $(TOOLS_DIR)
	gcc -c -I$(LIBCLAP_HEADERS_DIR) $(DEBUG_FLAGS) -Wno-nullability-completeness -o $@ $<
