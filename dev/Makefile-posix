# --------------------------------------------------------------------------
# Builds:
#   diskimage
#	libtool
#	keymap
#   makerom
#   libclap
#
# and puts them inside the build/host folder.
#


# --------------------------------------------------------------------------
# Common Directories
#

BUILD_DIR := ../build
TOOLS_DIR := $(BUILD_DIR)/host
OBJS_DIR := $(TOOLS_DIR)/objs
LIBS_DIR := ../user/lib
TOOLS_SOURCES_DIR := bin
LIBCLAP_DIR := $(LIBS_DIR)/libclap
LIBCLAP_HEADERS_DIR := $(LIBCLAP_DIR)/h
LIBCLAP_SOURCES_DIR := $(LIBCLAP_DIR)/src


# --------------------------------------------------------------------------
# Common Settings
#

#DEBUG_FLAGS := /Od /Zi
DEBUG_FLAGS :=


# --------------------------------------------------------------------------
# Includes
#

include ../common.mk


# --------------------------------------------------------------------------
# Build rules
#

.SUFFIXES:
.PHONY: clean


default: all

all: libclap makerom libtool keymap
#all: libclap makerom libtool keymap diskimage
#diskimage: $(TOOLS_DIR)/diskimage
keymap: $(TOOLS_DIR)/keymap
libtool: $(TOOLS_DIR)/libtool
makerom: $(TOOLS_DIR)/makerom
libclap: $(OBJS_DIR)/libclap.ar

clean:
	$(call rm_if_exists,$(OBJS_DIR))


$(TOOLS_DIR):
	$(call mkdir_if_needed,$(TOOLS_DIR))

$(OBJS_DIR):
	$(call mkdir_if_needed,$(OBJS_DIR))


# --------------------------------------------------------------------------
# libclap
#

LIBCLAP_H_SOURCES := $(wildcard $(LIBCLAP_SOURCES_DIR)/*.h)
LIBCLAP_C_SOURCES := $(wildcard $(LIBCLAP_SOURCES_DIR)/*.c)
LIBCLAP_OBJS := $(patsubst $(LIBCLAP_SOURCES_DIR)/%.c, $(OBJS_DIR)/%.o, $(LIBCLAP_C_SOURCES))

$(OBJS_DIR)/libclap.ar: $(LIBCLAP_OBJS)
	ar rvs $@ $^

$(OBJS_DIR)%.o: $(LIBCLAP_SOURCES_DIR)%.c $(LIBCLAP_H_SOURCES) | $(OBJS_DIR)
	gcc -c -I$(LIBCLAP_HEADERS_DIR) $(DEBUG_FLAGS) -Wno-nullability-completeness -o $@ $<


# --------------------------------------------------------------------------
# diskimage
#

# XXX not yet


# --------------------------------------------------------------------------
# keymap
#

KEYMAP_C_SOURCES := bin/keymap.c
KEYMAP_OBJS := $(patsubst $(TOOLS_SOURCES_DIR)/%.c, $(OBJS_DIR)/%.o, $(KEYMAP_C_SOURCES))

$(TOOLS_DIR)/keymap: $(KEYMAP_OBJS) $(OBJS_DIR)/libclap.ar
	gcc -o $@ $^

$(OBJS_DIR)/%.o: $(TOOLS_SOURCES_DIR)/%.c | $(OBJS_DIR) $(TOOLS_DIR)
	gcc -c -I$(LIBCLAP_HEADERS_DIR) $(DEBUG_FLAGS) -Wno-nullability-completeness -o $@ $<


# --------------------------------------------------------------------------
# libtool
#

LIBTOOL_C_SOURCES := bin/libtool.c
LIBTOOL_OBJS := $(patsubst $(TOOLS_SOURCES_DIR)/%.c, $(OBJS_DIR)/%.o, $(LIBTOOL_C_SOURCES))

$(TOOLS_DIR)/libtool: $(LIBTOOL_OBJS) $(OBJS_DIR)/libclap.ar
	gcc -o $@ $^

$(OBJS_DIR)/%.o: $(TOOLS_SOURCES_DIR)/%.c | $(OBJS_DIR) $(TOOLS_DIR)
	gcc -c -I$(LIBCLAP_HEADERS_DIR) $(DEBUG_FLAGS) -Wno-nullability-completeness -o $@ $<


# --------------------------------------------------------------------------
# makerom
#

MAKEROM_C_SOURCES := bin/makerom.c
MAKEROM_OBJS := $(patsubst $(TOOLS_SOURCES_DIR)/%.c, $(OBJS_DIR)/%.o, $(MAKEROM_C_SOURCES))

$(TOOLS_DIR)/makerom: $(MAKEROM_OBJS) $(OBJS_DIR)/libclap.ar
	gcc -o $@ $^

$(OBJS_DIR)/%.o: $(MAKEROM_C_SOURCES)/.%c | $(OBJS_DIR) $(TOOLS_DIR)
	gcc -c -I$(LIBCLAP_HEADERS_DIR) $(DEBUG_FLAGS) -Wno-nullability-completeness -o $@ $<
